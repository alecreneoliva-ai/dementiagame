import { launchConfetti } from "./confetti.js";
import { playWinJingle } from "./audio.js";

const LS_KEY_SETTINGS = "ba2_settings";
const LS_KEY_PROGRESS = "ba2_progress";

const DEFAULT_SETTINGS = { lang:"en", sound:true };
const DEFAULT_PROGRESS = {
  find: { level:1 },
  match:{ level:1 },
  order:{ level:1 }
};

export const STR = {
  en: {
    title:"Brain Activities",
    tagline:"Simple, calm, and supportive.",
    menuTitle:"Choose an activity",
    orientation:"ðŸ§­ Daily Orientation",
    routine:"ðŸ—“ï¸ Daily Routine",
    find:"ðŸ”Ž Find the picture",
    match:"ðŸ§  Match pairs",
    order:"ðŸ”¢ Order numbers",
    reminisce:"ðŸ’¬ Reminiscence",
    reset:"Reset Progress",
    test:"Test Celebration ðŸŽ‰",
    footer:"Tip: Tap the ðŸ”Š to read instructions out loud."
  },
  es: {
    title:"Actividades Mentales",
    tagline:"Simple, tranquila y de apoyo.",
    menuTitle:"Elige una actividad",
    orientation:"ðŸ§­ OrientaciÃ³n diaria",
    routine:"ðŸ—“ï¸ Rutina diaria",
    find:"ðŸ”Ž Encuentra la imagen",
    match:"ðŸ§  Emparejar pares",
    order:"ðŸ”¢ Ordenar nÃºmeros",
    reminisce:"ðŸ’¬ Recordar",
    reset:"Reiniciar progreso",
    test:"Probar celebraciÃ³n ðŸŽ‰",
    footer:"Consejo: Toca ðŸ”Š para leer en voz alta."
  },
  ar: {
    title:"ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„Ù…Ø®",
    tagline:"Ø¨Ø¨Ø³Ø§Ø·Ø© ÙˆÙ‡Ø¯ÙˆØ¡ ÙˆØ¯Ø¹Ù….",
    menuTitle:"Ø§Ø®ØªØ§Ø± Ù†Ø´Ø§Ø·",
    orientation:"ðŸ§­ Ù…Ø¹Ø±ÙØ© Ø§Ù„ÙŠÙˆÙ…",
    routine:"ðŸ—“ï¸ Ø±ÙˆØªÙŠÙ† ÙŠÙˆÙ…ÙŠ",
    find:"ðŸ”Ž Ø¯ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø©",
    match:"ðŸ§  Ø·Ø§Ø¨Ù‚ Ø§Ù„Ø§ØªÙ†ÙŠÙ†",
    order:"ðŸ”¢ Ø±ØªØ¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…",
    reminisce:"ðŸ’¬ Ø°ÙƒØ±ÙŠØ§Øª",
    reset:"Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·",
    test:"Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ø§Ø­ØªÙØ§Ù„ ðŸŽ‰",
    footer:"Ù†ØµÙŠØ­Ø©: Ø¯ÙˆØ³ Ø¹Ù„Ù‰ ðŸ”Š Ø¹Ø´Ø§Ù† ÙŠÙ‚Ø±Ø§ Ø¨ØµÙˆØª."
  }
};

function loadJson(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return fallback;
    return JSON.parse(raw);
  }catch(e){
    return fallback;
  }
}

function saveJson(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

export function getSettings(){
  return { ...DEFAULT_SETTINGS, ...loadJson(LS_KEY_SETTINGS, {}) };
}
export function setSettings(next){
  saveJson(LS_KEY_SETTINGS, next);
}

export function getProgress(){
  return { ...DEFAULT_PROGRESS, ...loadJson(LS_KEY_PROGRESS, {}) };
}
export function resetProgress(){
  saveJson(LS_KEY_PROGRESS, DEFAULT_PROGRESS);
}

function applyLanguageToHome(lang){
  const s = STR[lang];
  const byId = (id)=>document.getElementById(id);

  if(byId("appTitle")) byId("appTitle").textContent = s.title;
  if(byId("tagline")) byId("tagline").textContent = s.tagline;
  if(byId("menuTitle")) byId("menuTitle").textContent = s.menuTitle;

  if(byId("btnOrientation")) byId("btnOrientation").textContent = s.orientation;
  if(byId("btnRoutine")) byId("btnRoutine").textContent = s.routine;
  if(byId("btnFind")) byId("btnFind").textContent = s.find;
  if(byId("btnMatch")) byId("btnMatch").textContent = s.match;
  if(byId("btnOrder")) byId("btnOrder").textContent = s.order;
  if(byId("btnReminisce")) byId("btnReminisce").textContent = s.reminisce;

  if(byId("resetBtn")) byId("resetBtn").textContent = s.reset;
  if(byId("testCelebrateBtn")) byId("testCelebrateBtn").textContent = s.test;
  if(byId("footerNote")) byId("footerNote").textContent = s.footer;

  document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";
  document.documentElement.lang = lang;
}

function updateSoundIcon(sound){
  const btn = document.getElementById("soundBtn");
  if(btn) btn.textContent = sound ? "ðŸ”Š" : "ðŸ”‡";
}

async function celebrate(settings){
  launchConfetti(1500);
  await playWinJingle(settings.sound);
}

export function initHome(){
  const settings = getSettings();
  const langSelect = document.getElementById("langSelect");
  if(langSelect){
    langSelect.value = settings.lang;
    langSelect.onchange = ()=>{
      const next = { ...getSettings(), lang: langSelect.value };
      setSettings(next);
      applyLanguageToHome(next.lang);
    };
  }

  applyLanguageToHome(settings.lang);
  updateSoundIcon(settings.sound);

  const soundBtn = document.getElementById("soundBtn");
  if(soundBtn){
    soundBtn.onclick = ()=>{
      const cur = getSettings();
      const next = { ...cur, sound: !cur.sound };
      setSettings(next);
      updateSoundIcon(next.sound);
    };
  }

  const resetBtn = document.getElementById("resetBtn");
  if(resetBtn){
    resetBtn.onclick = ()=>{
      resetProgress();
      launchConfetti(700);
    };
  }

  const testBtn = document.getElementById("testCelebrateBtn");
  if(testBtn){
    testBtn.onclick = ()=> celebrate(getSettings());
  }
}
